<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Write to Her | Secret Mailbox</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Inter:wght@300;500&family=Dancing+Script:wght@500&family=Homemade+Apple&family=Playfair+Display:ital@1&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        /* RADIAL VIGNETTE BACKGROUND */
        body { 
            margin: 0; 
            height: 100vh;
            background: radial-gradient(circle at center, #2a2a2a 0%, #000000 90%);
            color: white; 
            font-family: 'Inter', sans-serif; 
            display: flex; flex-direction: column; align-items: center; 
            overflow: hidden; /* Important for the flying owl */
        }

        /* --- STAGE 1: THE ENVELOPE --- */
        #envelope-stage {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 100vh; width: 100%; transition: 0.8s ease-in-out; z-index: 10;
        }
        
        .envelope {
            width: 300px; height: 200px; background: #1a1a1a; 
            position: relative; border-radius: 5px;
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; transition: 0.3s;
            box-shadow: 0 15px 35px rgba(0,0,0,0.8);
            border: 1px solid #333;
        }
        .envelope:hover { transform: scale(1.05) translateY(-5px); box-shadow: 0 20px 40px rgba(0,0,0,1); }
        
        .envelope::before {
            content: ''; position: absolute; top: 0; left: 0; 
            width: 0; height: 0; 
            border-left: 150px solid transparent;
            border-right: 150px solid transparent;
            border-top: 100px solid #252525;
            transform-origin: top; transition: 0.5s; z-index: 2;
        }
        
        .wax-seal {
            width: 60px; height: 60px; background: #8b0000;
            border-radius: 50%; z-index: 10;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5), 0 5px 10px rgba(0,0,0,0.5);
            display: flex; justify-content: center; align-items: center;
            font-family: 'Cinzel', serif; font-size: 28px; color: rgba(0,0,0,0.4);
            border: 2px dashed rgba(255,255,255,0.1);
        }

        .tap-hint { margin-top: 30px; opacity: 0.5; letter-spacing: 3px; text-transform: uppercase; font-size: 0.8rem; font-family: 'Cinzel', serif; animation: pulse 2s infinite; }

        /* --- STAGE 2: THE WRITING DESK --- */
        #writing-desk {
            display: none; width: 100%; max-width: 600px; height: 100vh;
            flex-direction: column; align-items: center; justify-content: center;
            opacity: 0; transform: translateY(50px); transition: 1s;
            position: relative; z-index: 5;
        }

        h2 { font-family: 'Cinzel', serif; color: #D4AF37; margin-bottom: 15px; text-shadow: 0 0 10px rgba(212, 175, 55, 0.3); }

        .toolbar { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; justify-content: center; }
        
        .tool-btn {
            background: rgba(0,0,0,0.6); border: 1px solid #444; color: #aaa;
            padding: 6px 12px; border-radius: 4px; cursor: pointer; transition: 0.3s;
            font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1px;
        }
        .tool-btn:hover { border-color: #D4AF37; color: #D4AF37; }

        /* THE MAGIC PAPER */
        .letter-paper {
            width: 90%; height: 50vh; padding: 40px;
            color: #222;
            border-radius: 2px; 
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
            font-family: 'Dancing Script', cursive; font-size: 1.5rem; line-height: 1.6;
            border: none; outline: none; resize: none;
            transition: 0.5s;
            
            /* EXTERNAL IMAGE TEXTURE */
            background-image: url('paper.jpg'); 
            background-size: cover;
            background-position: center;
            /* Default blend mode */
            background-blend-mode: normal;
        }
        
        /* CSS BLENDING MODES */
        .style-classic { background-color: transparent; } /* Just the image */
        .style-midnight { background-color: #222; background-blend-mode: hard-light; color: #D4AF37; }
        .style-parchment { background-color: #d4c5a3; background-blend-mode: multiply; color: #3b2a1a; }
        .style-rose { background-color: #ffe4e1; background-blend-mode: multiply; color: #6d0f0f; }

        .inputs-row { display: flex; gap: 10px; width: 90%; margin-top: 15px; }
        .simple-input {
            flex: 1; padding: 12px; background: rgba(0,0,0,0.6); border: 1px solid #444; 
            color: white; border-radius: 4px; outline: none; font-family: 'Inter', sans-serif;
        }
        .simple-input:focus { border-color: #D4AF37; }

        .seal-btn {
            margin-top: 25px; background: #8b0000; color: white;
            border: 1px solid #500; padding: 12px 40px; border-radius: 50px;
            font-family: 'Cinzel', serif; font-size: 1rem; cursor: pointer;
            box-shadow: 0 0 20px rgba(139, 0, 0, 0.4);
            transition: 0.3s;
        }
        .seal-btn:hover { transform: scale(1.05); background: #a50000; box-shadow: 0 0 30px rgba(165, 0, 0, 0.6); }

        .privacy-note { margin-top: 15px; font-size: 0.7rem; opacity: 0.4; display: flex; align-items: center; gap: 5px; }

        /* --- STAGE 3: THE OWL & SUCCESS --- */
        #success-msg {
            display: none; flex-direction: column; align-items: center; justify-content: center;
            height: 100vh; text-align: center; position: absolute; top:0; width: 100%; z-index: 20;
        }
        
        /* THE HEDWIG ANIMATION */
        #hedwig-img {
            position: absolute;
            bottom: -200px; left: 50%;
            width: 200px;
            transform: translateX(-50%);
            display: none;
            z-index: 100;
        }

        /* Animation Keyframes */
        @keyframes flyAway {
            0% { bottom: -200px; left: 50%; transform: translateX(-50%) scale(1); }
            40% { bottom: 40%; left: 50%; transform: translateX(-50%) scale(1.2); }
            100% { bottom: 120%; left: 120%; transform: translateX(-50%) scale(0.5); }
        }

        @keyframes pulse { 0% { opacity: 0.3; } 50% { opacity: 0.8; } 100% { opacity: 0.3; } }
        @keyframes stamp { 0% { transform: scale(3); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }

    </style>
</head>
<body>

    <div id="envelope-stage" onclick="openDesk()">
        <div class="envelope">
            <div class="wax-seal">H</div>
        </div>
        <div class="tap-hint">Tap to break the seal</div>
    </div>

    <div id="writing-desk">
        <h2>Write to Her</h2>
        
        <div class="toolbar">
            <div class="tool-btn" onclick="setPaper('style-classic')">Original</div>
            <div class="tool-btn" onclick="setPaper('style-midnight')">Midnight</div>
            <div class="tool-btn" onclick="setPaper('style-parchment')">Aged</div>
            <div class="tool-btn" onclick="setPaper('style-rose')">Rose</div>
            
            <select id="moodSelect" class="tool-btn" style="background:rgba(0,0,0,0.6); color:#aaa; border:1px solid #444;">
                <option value="heartfelt">‚ù§Ô∏è Heartfelt</option>
                <option value="nostalgic">üï∞Ô∏è Nostalgic</option>
                <option value="funny">üòÇ Funny</option>
                <option value="proud">‚ú® Proud</option>
            </select>
        </div>

        <textarea id="letterBody" class="letter-paper style-classic" placeholder="Dearest..."></textarea>

        <div class="inputs-row">
            <input type="text" id="senderName" class="simple-input" placeholder="Your Name">
            <input type="text" id="oneWord" class="simple-input" placeholder="One word describing her">
        </div>

        <div class="privacy-note">
            <svg width="12" height="12" fill="currentColor" viewBox="0 0 16 16"><path d="M8 1a2 2 0 0 1 2 2v4H6V3a2 2 0 0 1 2-2zm3 6V3a3 3 0 0 0-6 0v4a2 2 0 0 0-2 2v5a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2z"/></svg>
            Encrypted & Private. Only she will open this.
        </div>

        <button class="seal-btn" id="sendBtn" onclick="sendLetter()">
            Seal & Deliver
        </button>
    </div>

    <div id="success-msg">
        <h1 style="font-family: 'Cinzel'; color: #D4AF37; margin-bottom: 10px;">Sent.</h1>
        <p style="font-family: 'Inter'; opacity: 0.7; max-width: 400px; line-height: 1.6;">
            Your letter has been sealed.<br>
            Hedwig is currently flying it to her digital archive.
        </p>
    </div>

    <img src="owl.gif" id="hedwig-img" alt="Hedwig">

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

        // --- PASTE YOUR FIREBASE CONFIG HERE ---
        const firebaseConfig = {
            apiKey: "AIzaSyBPHhWTmAqPkZ8mRSGGxcBp3lgWUBzstMk",
            authDomain: "website-665c0.firebaseapp.com",
            projectId: "website-665c0",
            storageBucket: "website-665c0.firebasestorage.app",
            messagingSenderId: "831316473256",
            appId: "1:831316473256:web:1671afdcfc4597383d199d",
            measurementId: "G-DFC7C5VNMZ"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const lettersCol = collection(db, "letters");

        // --- UI LOGIC ---
        window.openDesk = () => {
            const env = document.getElementById('envelope-stage');
            const desk = document.getElementById('writing-desk');
            
            env.style.transform = 'translateY(-100vh)';
            env.style.opacity = '0';
            setTimeout(() => {
                env.style.display = 'none';
                desk.style.display = 'flex';
                setTimeout(() => {
                    desk.style.opacity = '1';
                    desk.style.transform = 'translateY(0)';
                }, 50);
            }, 600);
        };

        window.setPaper = (styleClass) => {
            const paper = document.getElementById('letterBody');
            paper.className = `letter-paper ${styleClass}`;
        };

        window.sendLetter = async () => {
            const btn = document.getElementById('sendBtn');
            const sender = document.getElementById('senderName').value.trim();
            const message = document.getElementById('letterBody').value.trim();
            const oneWord = document.getElementById('oneWord').value.trim();
            const mood = document.getElementById('moodSelect').value;
            
            // Determine style for DB
            const paper = document.getElementById('letterBody');
            let style = 'classic';
            if(paper.classList.contains('style-midnight')) style = 'midnight';
            if(paper.classList.contains('style-parchment')) style = 'parchment';
            if(paper.classList.contains('style-rose')) style = 'rose';

            if(!sender || !message) {
                alert("A letter needs a name and a message!");
                return;
            }

            btn.disabled = true;
            btn.innerText = "Sealing...";

            try {
                await addDoc(lettersCol, {
                    sender,
                    message,
                    oneWord,
                    mood,
                    style,
                    timestamp: serverTimestamp()
                });

                // --- TRIGGER HEDWIG ANIMATION ---
                const desk = document.getElementById('writing-desk');
                const owl = document.getElementById('hedwig-img');
                const success = document.getElementById('success-msg');

                // 1. Hide desk
                desk.style.opacity = '0';
                desk.style.transform = 'translateY(50px)';
                
                setTimeout(() => {
                    desk.style.display = 'none';
                    
                    // 2. Fly Owl
                    owl.style.display = 'block';
                    owl.style.animation = 'flyAway 4s ease-in-out forwards';
                    
                    // 3. Show Success Text after owl passes
                    setTimeout(() => {
                        success.style.display = 'flex';
                        // Confetti for magic effect
                        confetti({ particleCount: 150, spread: 100, origin: { y: 0.6 }, colors: ['#D4AF37', '#ffffff'] });
                    }, 1500);

                }, 800);
                
            } catch (e) {
                console.error(e);
                alert("The owl couldn't fly (Network Error). Try again.");
                btn.disabled = false;
                btn.innerText = "Seal & Deliver";
            }
        };
    </script>
</body>
</html>